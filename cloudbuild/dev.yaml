steps:
  - id: Initiate gcloud
    name: gcr.io/cloud-builders/gcloud
    entrypoint: sh
    args:
      - '-c'
      - |
          echo
          echo "**********************************************"
          echo "* Set backend project Id ${_PROJECT_ID} *"
          echo "**********************************************"
          echo

          gcloud config set project ${_PROJECT_ID}
          gcloud config set compute/region ${_PROJECT_REGION}

          echo
          echo "**************************************"
          echo "* Replace variables in .firebaserc file *"
          echo "**************************************"
          echo

          awk '{gsub(/<PROJECT_ID>/,"'${_PROJECT_ID}'")}1' /workspace/.firebaserc > /workspace/tmp.firebaserc && mv /workspace/tmp.firebaserc /workspace/.firebaserc


  - id: Build functions
    name: node:10.22-alpine
    entrypoint: sh
    args:
      - '-c'
      - |
          npm install -g firebase-tools
          npm install --save firebase-functions@latest

          cd ./functions
          npm install

          npm run build

  - id: "Deploy functions"
    name: "gcr.io/$PROJECT_ID/firebase"
    args: [
      "deploy",
      "--only=functions",
      "--project=${_PROJECT_ID}"
    ]

  - id: "Deploy firestore rules"
    name: "gcr.io/$PROJECT_ID/firebase"
    args: ["deploy", "--only=firestore:rules", "--project=${_PROJECT_ID}"]